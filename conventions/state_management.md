# 状態管理方針（Flutter）

このドキュメントでは、bpay アプリにおける状態管理の方針を記載します。特に、ログイン状態・トークンの保存と読み出し・遷移制御などについての仕様を整理します。


## 1. 状態管理の基本方針

- Riverpod（`flutter_riverpod`）を推奨ライブラリとする（拡張性とテスト容易性のため）
- アプリの状態は以下のように分類して保持
  - **認証状態（ログイン済みか）**
  - **ユーザー情報（メールアドレスなど）**
  - **アプリ内部の一時的状態（ローディング、エラー、入力値）**
- 状態の可視性・再利用性を高めるため、状態はグローバル Provider で管理


## 2. 認証状態の管理

### トークンの保存と読み出し

#### 保存（ログイン画面）
- ログイン成功時、アクセストークンは `flutter_secure_storage` に保存する
- 保存時のキー名は `"auth_token"` を基本とする
- 保存処理は以下のように記述：
  ```dart
  final storage = FlutterSecureStorage();
  await storage.write(key: 'auth_token', value: token);
  ```

#### 読み出し（スプラッシュ画面）
- 起動時（SplashScreen）に `auth_token` を読み出し、ログイン状態を判定する
- 読み出し処理：
  ```dart
  final storage = FlutterSecureStorage();
  final token = await storage.read(key: 'auth_token');
  ```
- トークンが存在する場合は `/home` に遷移、存在しない場合は `/login` に遷移

#### トークン検証（将来的な拡張）
- トークンが存在していても期限切れの可能性があるため、APIで有効性を確認しても良い
- 期限切れ判定は `exp` クレームの検証か、検証エンドポイントの活用を検討


## 3. Provider 構成（例）

- `authProvider`: ログイン状態の真偽値を保持
- `userProvider`: ログインユーザーの属性情報を保持（メールアドレスなど）
- `tokenProvider`: JWTアクセストークンの状態（初期取得・再取得）


## 4. 状態管理の責務分離

| 層         | 責務内容                             |
|------------|--------------------------------------|
| UI層       | Provider を監視し表示を制御         |
| ロジック層 | 認証・状態変更・ストレージ操作を実施 |
| データ層   | API通信・トークン保存・取得          |


## 5. 備考

- Secure Storageは**非同期**であり、状態判定の初期化処理では `FutureProvider` を使うとよい
- 将来的にセッション管理のスケーラビリティが必要な場合、Refresh Token方式やセッションサーバーの導入も検討

---

以上の方針をもとに、アプリ全体の状態を統一的に管理し、認証処理の信頼性・再利用性を高めます。
